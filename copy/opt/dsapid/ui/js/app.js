function HomeCtrl(t,e,n,i){t.datasets=null,t.latest=null,e.query&&(t.query=e.query),i.then(function(e){t.datasets=e.all(),t.latest=e.latest()}),t.editManifest=function(t){n.path("/configure/"+t)}}function BuilderCtrl(t,e,n){function i(t){for(prop in t)t.hasOwnProperty(prop)&&delete t[prop];return t}function r(e){for(k in e)t.form.settings[k]=e[k]}t.dataset=null,t.form={settings:{},nics:[],disks:[],filesystems:[],metadata:[],_selected_metadata:null},t.temp,t.addNic=function(){i(t.temp),t.temp={nic_tag:"admin"},t.isKVM()&&(t.temp.model=t.dataset.nic_driver?t.dataset.nic_driver:t.valid_nic_models[0])},t.editNic=function(e){var n={};angular.copy(e,n),n._target=e,t.temp=n},t.saveNic=function(e){var n={};if(angular.copy(e,n),n.primary===!0){var r,a;for(r=0,a=t.form.nics.length;a>r;r++)t.form.nics[r].primary=!1}Object.keys(n).length>0&&n.nic_tag&&n.ip&&(e._target?(delete n._target,angular.copy(n,e._target)):t.form.nics.push(n)),i(t.temp)},t.removeNic=function(e){var n=t.form.nics.indexOf(e);n>=0&&t.form.nics.splice(n,1)},t.addFilesystem=function(){i(t.temp),t.temp={type:t.valid_filesystem_types[0]}},t.editFilesystem=function(e){var n={};angular.copy(e,n),n._target=e,t.temp=n},t.saveFilesystem=function(e){var n={};angular.copy(e,n),Object.keys(n).length>0&&n.type&&n.source&&n.target&&(e._target?(delete n._target,angular.copy(n,e._target)):t.form.filesystems.push(n)),i(t.temp)},t.removeFilesystem=function(e){var n=t.form.filesystems.indexOf(e);n>=0&&t.form.filesystems.splice(n,1)},t.addDisk=function(){i(t.temp),t.temp={model:t.dataset.disk_driver?t.dataset.disk_driver:t.valid_disk_models[0],compression:t.valid_disk_compressions[0].type}},t.editDisk=function(e){var n={};angular.copy(e,n),n._target=e,t.temp=n},t.saveDisk=function(e){var n={};angular.copy(e,n),Object.keys(n).length>0&&n.model&&n.size&&(e._target?(delete n._target,angular.copy(n,e._target)):t.form.disks.push(n)),i(t.temp)},t.removeDisk=function(e){var n=t.form.disks.indexOf(e);n>=0&&t.form.disks.splice(n,1)},t.addMetadata=function(e){var n={};i(t.temp),e?"password"===e.type&&e.initWithRandom(24):e={name:"",type:"custom",value:"",description:"custom key"},angular.copy(e,n),t.temp=n},t.editMetadata=function(e){var n={};angular.copy(e,n),n._target=e,t.temp=n},t.saveMetadata=function(e){var n={};angular.copy(e,n),Object.keys(n).length>0&&n.name&&n.value&&("custom"===n.type&&(n.title=n.name),e._target?(delete n._target,angular.copy(n,e._target)):t.form.metadata.push(n)),i(t.temp),t.form._selected_metadata=null},t.removeMetadata=function(e){var n=t.form.metadata.indexOf(e);n>=0&&t.form.metadata.splice(n,1)},t.json={},t.json_pretty="",t.generateJson=function(){var e=t.dataset.getGenerator();e.setOptions(t.form.settings),e.setNics(t.form.nics),e.setFilesystems(t.form.filesystems),e.setDisks(t.form.disks),e.setMetadata(t.form.metadata),t.json=e.generate(),t.changeOutput("json")},t.changeOutput=function(e){t.json_pretty="shell"===e?["vmadm create << EOF",JSON.stringify(t.json,null,2),"EOF"].join("\n"):[JSON.stringify(t.json,null,2)].join("\n")},t.isJoyent=function(){return t.dataset&&("joyent"===t.dataset.getBrand()||"joyent-minimal"===t.dataset.getBrand())},t.isKVM=function(){return t.dataset&&"kvm"===t.dataset.getBrand()},n.then(function(n){t.dataset=n.by_uuid(e.uuid),t.dataset.manifest.builder_info&&r(t.dataset.manifest.builder_info)}),t.valid_filesystem_types=["lofs"],t.valid_disk_models=["virtio","ide","scsi"],t.valid_disk_compressions=[{type:"off"},{type:"on"},{type:"lzjb"},{type:"gzip"},{type:"zle"},{type:"gzip-1",group:"gzip"},{type:"gzip-2",group:"gzip"},{type:"gzip-3",group:"gzip"},{type:"gzip-4",group:"gzip"},{type:"gzip-5",group:"gzip"},{type:"gzip-6",group:"gzip"},{type:"gzip-7",group:"gzip"},{type:"gzip-8",group:"gzip"},{type:"gzip-9",group:"gzip"}],t.valid_nic_models=["virtio","e1000","rtl8139"],t.valid_cpu_types=["qemu64","host"]}function MetadataOption(t){this.group=t.group||"",this.name=t.name||"",this.title=t.title||this.name,this.description=t.description||"",this.type=t.type||"text",this.value=t.value||"",this.initWithRandom=function(t){function e(t){for(var e="0123456789ABCDEFGHIJKLMNOPQRSTUVWXTZabcdefghiklmnopqrstuvwxyz",n="";n.length<t;)n+=e.substr(Math.floor(Math.random()*e.length),1);return n}t=t||8,this.value=e(t)}}function Dataset(t){this.manifest=t,this.metadata=[];var e=null;this.getGenerator=function(){return null===e&&(e=new DatasetJsonGenerator(this)),e},this.getCreator=function(){if(t.provider)return t.provider;switch(t.creator_name){case"sdc":case"jpc":return"joyent";default:return"community"}},this.getBrand=function(){return"smartos"!==t.os?"kvm":"joyent"};var n,i=["name","version","os","description","homepage","uuid","published_at","stats_info"];for(n in i)this[i[n]]=this.manifest[i[n]];if(this.published_at=Date.parse(this.published_at),this.metadata.push(new MetadataOption({name:"user-script",title:"User-Script",description:"bash script to be run at first boot used to provision even more stuff automatically",type:"text"})),this.metadata.push(new MetadataOption({name:"user-data",title:"User-Data",description:"data that can be used by the user-script",type:"text"})),"kvm"===this.getBrand())this.manifest.hasOwnProperty("requirements")&&this.manifest.requirements&&this.manifest.requirements.hasOwnProperty("ssh_key")&&this.manifest.requirements.ssh_key&&this.metadata.push(new MetadataOption({group:"password",title:"SSH-PubKey",name:"root_authorized_keys",type:"text",description:"sets authorized_keys for the root user"}));else if(this.manifest.users)for(n in this.manifest.users){var r=this.manifest.users[n];this.metadata.push(new MetadataOption({group:"password",title:r.name,name:r.name+"_pw",type:"password",description:"sets the password for the user"}))}else(["smartos","smartos64","base","base64"].indexOf(this.manifest.name)>=0||"smartos"===this.manifest.os)&&(this.metadata.push(new MetadataOption({group:"password",title:"root",name:"root_pw",type:"password",description:"sets the password for the user"})),this.metadata.push(new MetadataOption({group:"password",title:"admin",name:"admin_pw",type:"password",description:"sets the password for the user"})));if(this.manifest.hasOwnProperty("metadata_info")){var a;for(n in this.manifest.metadata_info)a=this.manifest.metadata_info[n],a.hasOwnProperty("group")||(a.group="custom"),this.metadata.push(new MetadataOption(a))}}function DatasetList(){function t(){var t,i={};n.length=0;for(t in e)i[e[t].name]||(i[e[t].name]=!0,n.push(e[t]))}var e=[],n=[];this.clear=function(){e.length=0,n.length=0},this.count=function(){return e.length},this.push=function(n,i){n.constructor!==Dataset&&(n=new Dataset(n)),e.push(n),i&&t()},this.pushMany=function(e){var n,i;for(n=0,i=e.length;i>n;n++)this.push(e[n],!0);t()},this.all=function(){return e},this.get=function(t){return t>=0&&t<e.length?e[t]:null},this.get_by_uuid=function(t){var n,i,r=null;for(n=0,i=e.length;i>n;n++)e[n].uuid===t&&(r=e[n]);return r},this.latest=function(){return n},this.clear()}function DatasetJsonGenerator(t){function e(t){return n(r,p,t)}function n(t,e,n){var i=null;if(t.hasOwnProperty(n)&&(i=t[n],"string"==typeof i&&0===i.length&&(i=null)),e[n]){var r=e[n];if(null===i)null!==r[1]&&(i="function"==typeof r[1]?r[1](t,e):r[1]);else switch(r[0]){case"boolean":i=!!i;break;case"integer":i=parseInt(i),i||(i=0);break;case"array":i=i.toString().split(/[\s,]+/),i||(i=null);break;default:i=i.toString()}}return i}var i=t,r={},a=[],s=[],o=[],u=[],l=i.getBrand();i.manifest.hasOwnProperty("options")&&(i.manifest.cpu_type=i.manifest.options.cpu_type,i.manifest.disk_driver=i.manifest.options.disk_driver,i.manifest.nic_driver=i.manifest.options.nic_driver,i.manifest.image_size=i.manifest.options.image_size);var p={image_uuid:["string",function(){return i.uuid},["joyent"]],autoboot:["boolean",!0,["kvm","joyent"]],alias:["string",null,["kvm","joyent"]],hostname:["string",null,["kvm","joyent"]],dns_domain:["string",null,["kvm","joyent"]],resolvers:["array",null,["kvm","joyent"]],max_physical_memory:["integer",function(){return"kvm"===i.getBrand()?null:256},["joyent"]],max_swap:["integer",function(){var t;return t=e("kvm"===i.getBrand()?"ram":"max_physical_memory")},["joyent"]],tmpfs:["integer",null,["joyent"]],ram:["integer",1024,["kvm"]],quota:["integer",null,["joyent"]],cpu_cap:["integer",null,["kvm","joyent"]],cpu_shares:["integer",null,["kvm","joyent"]],max_lwps:["integer",null,["kvm","joyent"]],cpu_type:["string","qemu64",["kvm"]],vcpus:["integer",null,["kvm"]]},f={nic_tag:["string",null,["kvm","joyent"]],mac:["string",null,["kvm","joyent"]],ip:["string",null,["kvm","joyent"]],netmask:["string",null,["kvm","joyent"]],gateway:["string",null,["kvm","joyent"]],model:["string",null,["kvm"]],vlan_id:["integer",null,["kvm","joyent"]],primary:["boolean",null,["kvm","joyent"]],allow_ip_spoofing:["boolean",null,["kvm","joyent"]],allow_mac_spoofing:["boolean",null,["kvm","joyent"]],allow_restricted_traffic:["boolean",null,["kvm","joyent"]]},m={boot:["boolean",!1,["kvm"]],image_uuid:["string",null,["kvm"]],size:["integer",null,["kvm"]],image_size:["integer",null,["kvm"]],model:["string",null,["kvm"]],compression:["string",null,["kvm"]]},c={type:["string","lofs",["joyent"]],source:["string",null,["joyent"]],target:["string",null,["joyent"]]};this.setOption=function(t,e){return r[t]=e,this},this.setOptions=function(t){var e;for(e in t)t.hasOwnProperty(e)&&this.setOption(e,t[e]);return this},this.setNics=function(t){var e;a.length=0;for(e in t)a.push(t[e])},this.setFilesystems=function(t){var e;s.length=0;for(e in t)s.push(t[e])},this.setDisks=function(t){var e;o.length=0,"kvm"===l&&i.manifest.image_size&&i.manifest.disk_driver&&o.push({boot:!0,model:i.manifest.disk_driver,image_size:i.manifest.image_size,image_uuid:i.uuid});for(e in t)o.push(t[e])},this.setMetadata=function(t){var e;u.length=0;for(e in t)u.push(t[e])},this.generate=function(){var t,i,r,d={};d.brand=l;for(t in p){var g=p[t];if(g[2].indexOf(l)>=0){var h=e(t);null!==h&&(d[t]=h)}}if(a.length>0)for(d.nics=[],i=0,r=a.length;r>i;i++){var v={};for(t in f){var g=f[t];if(g[2].indexOf(l)>=0){var h=n(a[i],f,t);null!==h&&(v[t]=h)}}d.nics.push(v)}if(o.length>0)for(d.disks=[],i=0,r=o.length;r>i;i++){var v={};for(t in m){var g=m[t];if(g[2].indexOf(l)>=0){var h=n(o[i],m,t);null!==h&&(v[t]=h)}}d.disks.push(v)}if(s.length>0)for(d.filesystems=[],i=0,r=s.length;r>i;i++){var v={};for(t in c){var g=c[t];if(g[2].indexOf(l)>=0){var h=n(s[i],c,t);null!==h&&(v[t]=h)}}d.filesystems.push(v)}if(u.length>0)for(d.customer_metadata={},d.internal_metadata={},i=0,r=u.length;r>i;i++)u[i].name.match(/_pw$/)&&(d.internal_metadata[u[i].name]=u[i].value),d.customer_metadata[u[i].name]=u[i].value;return d}}!function(){"use strict";var t="undefined"!=typeof window?window:global;if("function"!=typeof t.require){var e={},n={},i=function(t,e){return{}.hasOwnProperty.call(t,e)},r=function(t,e){var n,i,r=[];n=/^\.\.?(\/|$)/.test(e)?[t,e].join("/").split("/"):e.split("/");for(var a=0,s=n.length;s>a;a++)i=n[a],".."===i?r.pop():"."!==i&&""!==i&&r.push(i);return r.join("/")},a=function(t){return t.split("/").slice(0,-1).join("/")},s=function(e){return function(n){var i=a(e),s=r(i,n);return t.require(s,e)}},o=function(t,e){var i={id:t,exports:{}};return n[t]=i,e(i.exports,s(t),i),i.exports},u=function(t,a){var s=r(t,".");if(null==a&&(a="/"),i(n,s))return n[s].exports;if(i(e,s))return o(s,e[s]);var u=r(s,"./index");if(i(n,u))return n[u].exports;if(i(e,u))return o(u,e[u]);throw new Error('Cannot find module "'+t+'" from "'+a+'"')},l=function(t,n){if("object"==typeof t)for(var r in t)i(t,r)&&(e[r]=t[r]);else e[t]=n},p=function(){var t=[];for(var n in e)i(e,n)&&t.push(n);return t};t.require=u,t.require.define=l,t.require.register=l,t.require.list=p,t.require.brunch=!0}}(),angular.module("dsapi",["ngRoute","dsapi.services","dsapi.directives","dsapi.bootstrap","dsapi.filters"]).config(["$locationProvider","$routeProvider",function(t,e){t.hashPrefix("!"),e.when("/home",{templateUrl:"views/home.html",controller:HomeCtrl}),e.when("/configure/search/:query",{templateUrl:"views/configure.html",controller:HomeCtrl}),e.when("/configure",{templateUrl:"views/configure.html",controller:HomeCtrl}),e.when("/configure/:uuid",{templateUrl:"views/builder/index.html",controller:BuilderCtrl}),e.when("/about",{templateUrl:"views/about.html",controller:HomeCtrl}),e.otherwise({redirectTo:"/home"})}]),HomeCtrl.$inject=["$scope","$routeParams","$location","dsapiDatasets"],BuilderCtrl.$inject=["$scope","$routeParams","dsapiDatasets"],angular.module("dsapi.directives",[]).directive("dateFromNow",function(){return function(t,e,n){t.$watch(n.dateFromNow,function(t){t&&t>0&&e.text(moment(t).fromNow())})}}),angular.module("dsapi.bootstrap",[]).directive("navBarTop",function(){return{restrict:"EC",transclude:!0,scope:{title:"@"},template:'<div class="navbar navbar-fixed-top"><div class="navbar-inner"><div class="container"><a class="brand" href="#!/">{{title}}</a><ul class="nav" ng-transclude></ul></div></div></div>',replace:!0}}).directive("navBarPills",function(){return{restrict:"EC",transclude:!0,template:'<ul class="nav nav-pills pull-right" ng-transclude></ul>',replace:!0}}).directive("navLocation",["$location",function(t){var e=function(t,e){var n=t.indexOf("/");n>0&&(t=t.substring(n,t.length-n+1));var i,r=t.split("/"),a=e.split("/");for(i in r)if(r[i]!==a[i])return!1;return!0};return{restrict:"EC",transclude:!0,scope:{href:"@"},link:function(n){n.location=function(n){return e(n.substr(1),t.url())}},template:'<li ng-class="{active: location(href)}"><a href="{{href}}" ng-transclude></a></li>',replace:!0}}]),angular.module("dsapi.filters",[]).filter("shorten",function(){return function(t,e){return e=e||4294967295,t.length>e&&(t=t.substring(0,e)+"..."),t}}).filter("searchDatasets",function(){var t=["name","version","os","description"],e=["uuid","name","version","os","description"],n=function(n,i){if(!i)return!0;var r,a,s,o,u;for(s=i.toLowerCase().split(/\s+/),a=0,o=s.length;o>a;a++){var l=!1;if(u=s[a].match(/^(\w+):(.+)$/),u&&e.indexOf(u[1])>=0)0===n[u[1]].toLowerCase().indexOf(u[2].toLowerCase())&&(l=!0);else for(r in t)n[t[r]].toLowerCase().search(s[a])>=0&&(l=!0);if(!l)return!1}return!0};return function(t,e){var i,r=[];if(!e)return t;for(i in t)n(t[i],e)&&r.push(t[i]);return r}}),angular.module("dsapi.services",[],["$provide",function(t){t.factory("dsapiDatasets",["$http","$q",function(t,e){var n=new DatasetList,i=e.defer(),r={count:function(){return n.count()},all:function(){return n.all()},latest:function(){return n.latest()},get:function(t){return n.get(t)},by_uuid:function(t){return n.get_by_uuid(t)}};return t.get("/api/datasets").success(function(t){n.pushMany(t),i.resolve(r)}).error(function(e,a){404==a?t.get("/datasets").success(function(t){n.pushMany(t),i.resolve(r)}):i.reject("Error loading datasets list.")}),i.promise}])}]);